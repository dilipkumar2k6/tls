# Certificate
- Is used to guarantee trust between two parties
# Hacker stealing data over HTTP
![](assets/steal-data-over-http.png)
# How to make it safe?
## Encrypt data using random generated key
- Encrypt data using key
![](assets/encrypt-data-using-key.png)
- Send encrypted data over network 
![](assets/send-encrypted-data.png)
Both server and hacker will get encrypted data
- Send copy of key over network 
![](assets/send-key-over-network.png)
Both server and hacker will get the key
- This is example of symmetric encryption key
![](assets/symmetric-encryption.png)
i.e. same key is used for encryption and for decryption
## Asymmetric encryption
- uses pair of key
- private key and public key
- For better understanding, we can call it private key and public lock
- key is only with sender so private, lock is available with everyone so public
How it works?
- encrypt your data using public lock (key)
- Those who has private key can unlock the data
![](assets/assymetric-key-lock.png)
![](assets/assymetric-key-lock-encryption.png)
![](assets/assymetric-key-lock-decryption.png)
# Asymmetric encryption SSH
![](assets/connect-to-server-ssh.png)
- Don't want to use password as it's risky to get hacked
- You decided to use public/private key
- Generate using `ssh-keygen`
    - private key
    - public key/lock
![](assets/generate-ssh-keys.png)
- Lock your serer using public lock
![](assets/lock-server-using-public-key.png)
- Decrypt data sent by server using private key
![](assets/ssh-to-server-using-private-key.png)
- Connect to multiple servers by applying same lock
![](assets/ssh-multiple-server.png)
- What if other user needs access of server?
    - They will do same thing
    - Generate public/private key
![](assets/ssh-second-user.png)
# How to send random generated key to send to server?
- somehow send key safely to the server
![](assets/share-key-problem.png)
- Once key is send safely then server and client can continue communication securely using shared private key
- To securely send key to server, we use asymmetric encryption
- Server generate private and public key 
![](assets/server-generates-asymmetric-keys.png)
- On starting handshake, server first sends the public lock/key to client 
![](assets/public-key-shared.png)
- hacker and client both receives the public lock
- client encrypt key using public lock
![](assets/client-encrypt-key-using-lock.png)
- client sends encrypted key to server
![](assets/client-sends-encrypted-key-to-server.png)
hacker also gets the data but no use
- server decrypt key using private key
![](assets/server-decrypt-to-get-key.png)
- Client and server continue secure communications
![](assets/client-server-secure-communications.png)
# Hacker breaking secure communication
- Use fishing email to capture user data
- Creates site exactly same as your bank site
![](assets/hacker-asymmetric-1.png)
- hosts site on his own server
- He wants you to think that its secure too, so he generates his own public/private key
![](assets/hacker-asymmetric-2.png)
- You now sends your real data in encrypted format
![](assets/hacker-asymmetric-3.png)
# How to make it more secure (TLS)?
- Add certificate along with public key and let client to validate it
![](assets/certificate-with-public-key.png)
![](assets/certificate.png)
- For web server, certificate `CN` must be same as URL
![](assets/certificate-example.png)
- If bank is known by multiple url then these should be defined in `Alternative Names` 
- Anyone can generate certificate like this :-) 
- You can generate one for yourself and say that you are google
- So, how to validate certificate who signed and issued?

# How to secure certificate generation?
- If you generate the certificate then you can signed it, this is known as self signed certificate.
- Certificate generated by Hacker will be self signed, you can check to verify
- Browser does for us
![](assets/browser-invalid-certificate.png)
- How to create legitimate certificate so that browser can validate it?
- By signing from signing authority or CA
![](assets/ca.png)
- Following are steps 
    - Generate certificate singing request 
    ![](assets/csr.png)
    - CA validate information
    ![](assets/sign-certificate.png)
    - CA signed information
- What if certificate is signed by fake CA
![](assets/fake-certificate.png)
- How browser will know that certificate is signed by Symantic not by other CA?
    - CA itself has public and private certificate
    ![](assets/ca-with-public-private-key.png)
    - CA uses private key to signed certificate
    - CA's public certificates are installed into browser
    ![](assets/ca-public-keys-in-browser-os.png)
    - Browser uses these public keys to validate if certificate is valid or not
# How to manage certificates for internal sites?
- hosts your own private Symantic as an CA
![](assets/host-ca-on-prem.png)
- Install public key on your employees browser/operating system
![](assets/on-prem-ca-pub-key-on-browser-os.png)
# Recap
- client and server
![](assets/client-and-server.png)
- Admin generate ssh certificates to lock the server
![](assets/admin-generate-certificate-to-lock-server-ssh.png)
- Server generates public/private key and csr and ask CA to sign it
![](assets/server-generate-certs.png)
- Server sends csr to CA
![](assets/server-send-csr-to-ca.png)
- CA signed csr using private key
![](assets/ca-sign-csr.png)
- During TLS communication, server send signed csr to client
![](assets/server-send-signed-ca-to-client.png)
- Client uses preinstalled CA public key to unlock signed csr and continue TLS
![](assets/client-server-secure-tls.png)
# Secure client (MTLS)
- What if hacker impersonate client ?
![](assets/hacker-as-client.png)
- Client generates pub/private/csr and send csr to CA
![](assets/client-generate-certs.png)
- Client sends signed csr to server
![](assets/client-send-signed-csr-to-server.png)
- Server validate client and continue TLS
![](assets/server-validate-client-certs.png)
# PKI
![](assets/pki.png)
# public and private key 
- Public and private keys are exchangable 
![](assets/public-private-key-exchanble.png)
- Following are few file format of pub/private keys
![](assets/keys-file-format.png)
# How java/node.js/python perform tls?
- OS is bundled with public keys of CAs
- If csr exchanged can be validated using preinstalled CA pub keys then good
- Installed certs in either predefined locations or custom location
# Certificate chain
- certificate can be singed by multiple CAs
    - Root certificate
    - Server certificate
    - Client certificate
![](assets/certificate-chain.png)
# K8 certificates
![](assets/k8-certificates.png)
# CA certs using OPENSSL
![](assets/openssl.png)
# Client using CA certs
![](assets/client-use-custom-ca.png)
# Use certs to create user account
- Add group details in the csr






